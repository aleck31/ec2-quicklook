const EC2QuickLook={elements:{},selectedType:'m5.xlarge',defaultFamilies:['m5','m6g'],init(){this.cacheElements();this.bindEvents();this.updateTypes()},cacheElements(){this.elements={arch:$('#arch'),region:$('#region'),family:$('#family'),types:$('#types'),btnQuery:$('#btnquery'),forms:document.getElementsByClassName('needs-validation')}},bindEvents(){this.setupFormValidation();this.elements.arch.on('change',()=>this.updateFamily());this.elements.region.on('change',()=>{this.selectedType=this.elements.types.val();this.updateTypes()});this.elements.family.on('change',()=>this.updateTypes());this.elements.btnQuery.on('click',()=>{this.queryInstance();this.queryVolume()})},setupFormValidation(){Array.prototype.filter.call(this.elements.forms,(form)=>{form.addEventListener('submit',(event)=>{if(form.checkValidity()===false){event.preventDefault();event.stopPropagation()}form.classList.add('was-validated')},false)})},updateFamily(){const region=this.elements.region.val();const arch=this.elements.arch.val();$.ajax({url:"instance/family",data:{region,arch},dataType:"json",beforeSend:()=>this.showLoading(this.elements.family),success:(result)=>{let familyOptions=["<option value=''>Choose...</option>"];result.forEach(item=>{const isDefault=this.defaultFamilies.includes(item.name);familyOptions.push(`<option ${isDefault?'selected':''}value="${item.name}">${item.description}:${item.name}</option>`);if(isDefault)this.updateTypes(item.name)});this.elements.family.html(familyOptions.join(''))},error:(xhr,status,error)=>{console.error('Failed to fetch instance families:',error);this.showError('Failed to load instance families')},complete:()=>this.hideLoading(this.elements.family)})},updateTypes(family){const params={region:this.elements.region.val(),arch:this.elements.arch.val(),family:family||this.elements.family.val()};$.ajax({url:"instance/types",data:params,dataType:"json",beforeSend:()=>this.showLoading(this.elements.types),success:(result)=>{let typeOptions=["<option value=''>Choose...</option>"];let unmatch=true;result.forEach(item=>{const isSelected=item.instanceType===this.selectedType;typeOptions.push(`<option ${isSelected?'selected':''}value="${item.instanceType}">${item.instanceType}</option>`);if(isSelected)unmatch=false});this.elements.types.html(typeOptions.join(''));if(unmatch)this.elements.types.prop("selectedIndex",1)},error:(xhr,status,error)=>{console.error('Failed to fetch instance types:',error);this.showError('Failed to load instance types')},complete:()=>this.hideLoading(this.elements.types)})},queryInstance(){const params={region:this.elements.region.val(),type:this.elements.types.val(),op:$('#operation').val()};$.ajax({url:"product/instance",data:params,dataType:"json",beforeSend:()=>this.showLoading($('#instance')),success:(result)=>this.updateInstanceUI(result),error:(xhr,status,error)=>{console.error('Failed to fetch instance data:',error);this.showError('Failed to load instance information')},complete:()=>this.hideLoading($('#instance'))})},queryVolume(){const params={region:this.elements.region.val(),type:$('#voltypes').val(),size:$('#volsize').val()};$.ajax({url:"product/volume",data:params,dataType:"json",beforeSend:()=>this.showLoading($('#tbvolspec')),success:(result)=>this.updateVolumeUI(result),error:(xhr,status,error)=>{console.error('Failed to fetch volume data:',error);this.showError('Failed to load volume information')},complete:()=>this.hideLoading($('#tbvolspec'))})},updateInstanceUI(result){if("listPrice"in result){$('#insprice').html(`${result.listPrice.pricePerUnit.currency}${result.listPrice.pricePerUnit.value.toFixed(2)}`);$('#insunit').html(result.listPrice.unit);$('#insdate').html(result.listPrice.effectiveDate);$('#insfamily').html(result.productMeta.instanceFamily);$('#instenan').html(result.productMeta.tenancy);$('#insloca').html(result.productMeta.location);$('#insurl').attr('href',result.productMeta.introduceUrl);$('#tbdetail').show();$('#detailurl').attr('href',`detail?region=${this.elements.region.val()}&type=${this.elements.types.val()}`)}else{this.resetInstanceUI()}this.updateTable('#tbhardware',result.hardwareSpecs);this.updateTable('#tbsoftware',result.softwareSpecs);this.updateTable('#tbinstorage',result.instanceStorage);this.updateTable('#tbfeature',result.productFeature)},updateVolumeUI(result){this.updateTable('#tbvolspec',result.productSpecs);$('#volprice').html(`${result.listPrice.pricePerUnit.currency}${result.listPrice.pricePerUnit.value.toFixed(2)}`);$('#volunit').html(result.listPrice.unit);$('#voldate').html(result.listPrice.effectiveDate);$('#voltype').html(result.productMeta.volumeType);$('#usagetype').html(result.productMeta.usagetype);$('#volmedia').html(result.productMeta.storageMedia);$('#volurl').attr('href',result.productMeta.introduceUrl)},resetInstanceUI(){$('#insprice').html('unknown');$('#insunit').html('Month');$('#insdate').html('');$('#insfamily').html('Not Found');$('#instenan').html('');$('#insloca').html('');$('#insurl').attr('href','');$('#tbdetail').hide()},updateTable(tableId,data){const rows=Object.entries(data).map(([key,value])=>`<tr><td>${key}</td><td>${value}</td></tr>`);$(tableId).html(rows.join(''))},showLoading(element){element.addClass('loading').prop('disabled',true)},hideLoading(element){element.removeClass('loading').prop('disabled',false)},showError(message){console.error(message)}};$(function(){EC2QuickLook.init()});